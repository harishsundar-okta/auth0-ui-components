name: Publish NPM Packages

on:
  push:
    branches:
      - main
    paths:
      - 'packages/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to publish (comma-separated, e.g., core,react or "all")'
        required: false
        default: 'all'
        type: string
      core_version:
        description: 'Version for @auth0-web-ui-components/core (e.g., 1.2.3, 1.0.0-beta.1). If empty, uses version from package.json'
        required: false
        type: string
      react_version:
        description: 'Version for @auth0-web-ui-components/react (e.g., 0.2.0, 0.1.0-beta.1). If empty, uses version from package.json'
        required: false
        type: string
      dry_run:
        description: 'Dry run (skip actual publishing)'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on:
      labels: ubuntu-22.04-2cpu-8ram-75ssd
    permissions:
      contents: read # to be able to clone the repo
      id-token: write # to enable use of OIDC for npm provenance

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup JFrog CLI
        id: setup-jfrog-cli
        uses: jfrog/setup-jfrog-cli@f0a84f35b0e0bd21838c5fb3e6788072d6540d13 # v4.6.0 at 2025-01-02
        env:
          JF_URL: https://a0us.jfrog.io
        with:
          oidc-provider-name: atko-cic

      - name: Setup NPM Authentication
        env:
          ARTIFACTORY_USER: ${{ steps.setup-jfrog-cli.outputs.oidc-user }}
          ARTIFACTORY_API_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}
        run: |
          curl -u $ARTIFACTORY_USER:$ARTIFACTORY_API_TOKEN https://a0us.jfrog.io/artifactory/api/npm/npm/auth/a0 > ~/.npmrc
          echo "registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc
          echo "@auth0-web-ui-components:registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Update package versions
        if: github.event.inputs.core_version != '' || github.event.inputs.react_version != ''
        run: |
          echo "ðŸ”§ Updating package versions..."
          
          # Function to validate version format
          validate_version() {
            local version=$1
            local package_name=$2
            if ! echo "$version" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$'; then
              echo "âŒ Invalid version format for $package_name: $version"
              echo "Version should follow semver format (e.g., 1.2.3, 1.0.0-beta.1, 1.0.0+build.1)"
              exit 1
            fi
          }
          
          # Function to update package.json version directly
          update_package_version() {
            local package_path=$1
            local new_version=$2
            local package_name=$3
            
            cd "$package_path"
            # Use node to update the version in package.json directly
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = '$new_version';
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            echo "âœ… Updated $package_name version to $new_version"
            cd - > /dev/null
          }
          
          # Update core package version if provided
          if [ -n "${{ github.event.inputs.core_version }}" ]; then
            CORE_VERSION="${{ github.event.inputs.core_version }}"
            echo "ðŸ” Validating core version format..."
            validate_version "$CORE_VERSION" "core"
            
            if [ -d "./packages/core" ]; then
              echo "ðŸ“ Updating @auth0-web-ui-components/core to version $CORE_VERSION"
              update_package_version "./packages/core" "$CORE_VERSION" "@auth0-web-ui-components/core"
            fi
          fi
          
          # Update react package version if provided
          if [ -n "${{ github.event.inputs.react_version }}" ]; then
            REACT_VERSION="${{ github.event.inputs.react_version }}"
            echo "ðŸ” Validating react version format..."
            validate_version "$REACT_VERSION" "react"
            
            if [ -d "./packages/react" ]; then
              echo "ðŸ“ Updating @auth0-web-ui-components/react to version $REACT_VERSION"
              update_package_version "./packages/react" "$REACT_VERSION" "@auth0-web-ui-components/react"
            fi
          fi
          
          echo "âœ… Version updates completed"

      - name: Run tests
        run: pnpm run test
        continue-on-error: true

      - name: Determine packages to publish
        id: packages
        run: |
          if [ "${{ github.event.inputs.packages }}" = "all" ] || [ -z "${{ github.event.inputs.packages }}" ]; then
            echo "packages=core,react" >> $GITHUB_OUTPUT
          else
            echo "packages=${{ github.event.inputs.packages }}" >> $GITHUB_OUTPUT
          fi

      - name: Publish Core package
        if: contains(steps.packages.outputs.packages, 'core')
        working-directory: ./packages/core
        run: |
          echo "Publishing @auth0-web-ui-components/core..."
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN: Would publish @auth0-web-ui-components/core"
            pnpm publish --dry-run --access public --no-git-checks
          else
            pnpm publish --access public --no-git-checks
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Publish React package
        if: contains(steps.packages.outputs.packages, 'react')
        working-directory: ./packages/react
        run: |
          echo "Publishing @auth0-web-ui-components/react..."
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN: Would publish @auth0-web-ui-components/react"
            pnpm publish --dry-run --access public --no-git-checks
          else
            pnpm publish --access public --no-git-checks
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Summary
        run: |
          echo "## ðŸ“¦ NPM Packages Published" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.packages.outputs.packages }}" == *"core"* ]]; then
            if [ -f "./packages/core/package.json" ]; then
              CORE_VERSION=$(node -p "require('./packages/core/package.json').version")
              echo "- âœ… @auth0-web-ui-components/core@$CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            else
              if [ -n "${{ github.event.inputs.core_version }}" ]; then
                echo "- âœ… @auth0-web-ui-components/core@${{ github.event.inputs.core_version }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… @auth0-web-ui-components/core" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          if [[ "${{ steps.packages.outputs.packages }}" == *"react"* ]]; then
            if [ -f "./packages/react/package.json" ]; then
              REACT_VERSION=$(node -p "require('./packages/react/package.json').version")
              echo "- âœ… @auth0-web-ui-components/react@$REACT_VERSION" >> $GITHUB_STEP_SUMMARY
            else
              if [ -n "${{ github.event.inputs.react_version }}" ]; then
                echo "- âœ… @auth0-web-ui-components/react@${{ github.event.inputs.react_version }}" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âœ… @auth0-web-ui-components/react" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Packages published to JFrog Artifactory: https://a0us.jfrog.io" >> $GITHUB_STEP_SUMMARY
