name: Publish NPM Packages to JFrog
on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to publish (comma-separated: core,react or "all")'
        required: false
        default: "all"
        type: string
      core_version:
        description: "Core version (e.g., 1.2.3, 1.0.0-beta.1). Leave empty for auto-bump"
        required: false
        type: string
      react_version:
        description: "React version (e.g., 0.2.0, 0.1.0-beta.1). Leave empty for auto-bump"
        required: false
        type: string
      dry_run:
        description: "Dry run (preview without publishing)"
        required: false
        default: false
        type: boolean
      skip_slack_notification:
        description: "Skip Slack notification"
        required: false
        default: false
        type: boolean

jobs:
  publish:
    name: Build, Publish & Version Bump
    runs-on:
      labels: ubuntu-22.04-2cpu-8ram-75ssd
    permissions:
      contents: write # Clone repo and commit version updates
      id-token: write # OIDC for npm provenance
      pull-requests: write # Create and manage pull requests

    # Prevent concurrent publishes to avoid conflicts
    concurrency:
      group: npm-publish-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Check for circular trigger prevention
        id: check-skip
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"

          echo "üìã Commit Info:"
          echo "  Message: $COMMIT_MSG"
          echo "  Author: $COMMIT_AUTHOR"
          echo ""

          # Check if commit message contains skip markers or is from automated version bump
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || \
             [[ "$COMMIT_MSG" == *"[ci skip]"* ]] || \
             [[ "$COMMIT_MSG" == *"chore: update package versions after publish"* ]] || \
             [[ "$COMMIT_MSG" == *"chore: bump package versions"* ]]; then
            echo "üõë Skipping workflow - commit is from automated version bump"
            echo "skip=true" >> $GITHUB_OUTPUT
            
            # Add summary
            echo "## ‚è≠Ô∏è Workflow Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This workflow was skipped because the commit is from an automated version bump." >> $GITHUB_STEP_SUMMARY
            echo "This prevents circular workflow triggers that could cause infinite loops." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Commit message:** \`$COMMIT_MSG\`" >> $GITHUB_STEP_SUMMARY
            echo "**Commit author:** $COMMIT_AUTHOR" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Proceeding with workflow"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version inputs
        if: |
          (github.event_name != 'push' || steps.check-skip.outputs.skip != 'true') &&
          github.event_name == 'workflow_dispatch' &&
          (github.event.inputs.core_version != '' || github.event.inputs.react_version != '')
        run: |
          echo "üîç Validating version inputs..."

          VALIDATION_FAILED=false

          # Validate core version format if provided
          if [ -n "${{ github.event.inputs.core_version }}" ]; then
            if [[ ! "${{ github.event.inputs.core_version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
              echo "‚ùå Invalid core version format: ${{ github.event.inputs.core_version }}"
              echo "   Expected format: X.Y.Z or X.Y.Z-beta.N"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ Core version format valid: ${{ github.event.inputs.core_version }}"
            fi
          fi

          # Validate react version format if provided
          if [ -n "${{ github.event.inputs.react_version }}" ]; then
            if [[ ! "${{ github.event.inputs.react_version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
              echo "‚ùå Invalid react version format: ${{ github.event.inputs.react_version }}"
              echo "   Expected format: X.Y.Z or X.Y.Z-beta.N"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ React version format valid: ${{ github.event.inputs.react_version }}"
            fi
          fi

          if [ "$VALIDATION_FAILED" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ùå Version Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please use valid semantic version format (e.g., 1.2.3 or 1.2.3-beta.1)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Import GPG key for commit signing
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        id: import-gpg
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Setup pnpm
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        uses: pnpm/action-setup@36de12bed180fa130ed56a35e7344f2fa7a820ab # v4

      - name: Setup Node.js
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup JFrog CLI
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        id: setup-jfrog-cli
        uses: jfrog/setup-jfrog-cli@f0a84f35b0e0bd21838c5fb3e6788072d6540d13 # v4.6.0 at 2025-01-02
        env:
          JF_URL: https://a0us.jfrog.io
        with:
          oidc-provider-name: atko-cic

      - name: Setup NPM Authentication
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        env:
          ARTIFACTORY_USER: ${{ steps.setup-jfrog-cli.outputs.oidc-user }}
          ARTIFACTORY_API_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}
        run: |
          echo "üîê Setting up NPM authentication..."
          curl -u $ARTIFACTORY_USER:$ARTIFACTORY_API_TOKEN https://a0us.jfrog.io/artifactory/api/npm/npm/auth/a0 > ~/.npmrc
          echo "registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc
          echo "@auth0-web-ui-components:registry=https://a0us.jfrog.io/artifactory/api/npm/npm/" >> ~/.npmrc
          echo "‚úÖ NPM authentication configured"

      - name: Install dependencies
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        run: |
          echo "üì¶ Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "‚úÖ Dependencies installed"

      - name: Build packages
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        run: |
          echo "üî® Building packages..."
          pnpm run build
          echo "‚úÖ Packages built successfully"

      - name: Auto-bump versions for manual dispatch
        if: |
          (github.event_name != 'push' || steps.check-skip.outputs.skip != 'true') &&
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.core_version == '' && 
          github.event.inputs.react_version == ''
        run: |
          echo "‚¨ÜÔ∏è Auto-bumping patch versions for manual workflow run"
          echo ""

          # Bump patch version for core package
          if [ -d "./packages/core" ]; then
            cd "./packages/core"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor}.\${patch + 1}\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "  ‚úÖ @auth0-web-ui-components/core: $current ‚Üí $new_version"
            cd - > /dev/null
          fi

          # Bump patch version for react package
          if [ -d "./packages/react" ]; then
            cd "./packages/react"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor}.\${patch + 1}\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "  ‚úÖ @auth0-web-ui-components/react: $current ‚Üí $new_version"
            cd - > /dev/null
          fi

      - name: Update package versions on main push
        if: |
          (github.event_name != 'push' || steps.check-skip.outputs.skip != 'true') &&
          github.event_name == 'push' && 
          github.ref == 'refs/heads/main'
        run: |
          set -e
          echo "Auto-bumping versions for main branch push"

          UPDATED_PACKAGES=()

          # Check what packages have changes
          core_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/core/" || true)
          react_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/react/" || true)

          # Bump core package if it has changes
          if [ -n "$core_changes" ] && [ -d "./packages/core" ]; then
            echo "Detected changes in core package"
            cd "./packages/core"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor}.\${patch + 1}\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "Bumped @auth0-web-ui-components/core: $current -> $new_version"
            UPDATED_PACKAGES+=("@auth0-web-ui-components/core@$new_version")
            cd - > /dev/null
          fi

          # Bump react package if it has changes  
          if [ -n "$react_changes" ] && [ -d "./packages/react" ]; then
            echo "Detected changes in react package"
            cd "./packages/react"
            current=$(node -p "require('./package.json').version")
            new_version=$(node -e "
              const pkg = require('./package.json');
              const [major, minor, patch] = pkg.version.split('.').map(Number);
              const newVersion = \`\${major}.\${minor}.\${patch + 1}\`;
              pkg.version = newVersion;
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
              console.log(newVersion);
            ")
            echo "Bumped @auth0-web-ui-components/react: $current -> $new_version"
            UPDATED_PACKAGES+=("@auth0-web-ui-components/react@$new_version")
            cd - > /dev/null
          fi

          # Store info for PR creation
          if [ ${#UPDATED_PACKAGES[@]} -gt 0 ]; then
            echo "HAS_VERSION_UPDATES=true" >> $GITHUB_ENV
            echo "UPDATED_PACKAGES_LIST=${UPDATED_PACKAGES[@]}" >> $GITHUB_ENV
            echo "Version updates prepared for PR creation"
          else
            echo "HAS_VERSION_UPDATES=false" >> $GITHUB_ENV
            echo "No package changes detected"
          fi

      - name: Set manual version updates
        if: |
          (github.event_name != 'push' || steps.check-skip.outputs.skip != 'true') &&
          (github.event.inputs.core_version != '' || github.event.inputs.react_version != '')
        run: |
          echo "üìù Setting manual version updates..."
          echo ""

          # Handle core package version
          if [ -n "${{ github.event.inputs.core_version }}" ]; then
            cd "./packages/core"
            current=$(node -p "require('./package.json').version")
            node -e "
              const pkg = require('./package.json');
              pkg.version = '${{ github.event.inputs.core_version }}';
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            echo "  ‚úÖ @auth0-web-ui-components/core: $current ‚Üí ${{ github.event.inputs.core_version }}"
            echo "CORE_VERSION=${{ github.event.inputs.core_version }}" >> $GITHUB_ENV
            cd - > /dev/null
          fi

          # Handle react package version
          if [ -n "${{ github.event.inputs.react_version }}" ]; then
            cd "./packages/react"
            current=$(node -p "require('./package.json').version")
            node -e "
              const pkg = require('./package.json');
              pkg.version = '${{ github.event.inputs.react_version }}';
              require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            echo "  ‚úÖ @auth0-web-ui-components/react: $current ‚Üí ${{ github.event.inputs.react_version }}"
            echo "REACT_VERSION=${{ github.event.inputs.react_version }}" >> $GITHUB_ENV
            cd - > /dev/null
          fi

      - name: Determine packages to publish
        if: |
          github.event_name != 'push' || 
          steps.check-skip.outputs.skip != 'true'
        id: packages
        run: |
          PACKAGES_TO_PUBLISH=""

          if [ "${{ github.event.inputs.packages }}" != "" ] && [ "${{ github.event.inputs.packages }}" != "all" ]; then
            # Manual package selection
            PACKAGES_TO_PUBLISH="${{ github.event.inputs.packages }}"
            echo "üì¶ Manual selection: $PACKAGES_TO_PUBLISH"
          else
            # Auto-detect packages to publish based on changes/updates
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              # For manual dispatch, publish all packages by default
              PACKAGES_TO_PUBLISH="core,react"
            else
              # For push events, detect changed packages
              core_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/core/" || true)
              react_changes=$(git diff --name-only HEAD~1 HEAD | grep "^packages/react/" || true)
              
              PACKAGES_ARRAY=()
              if [ -n "$core_changes" ]; then
                PACKAGES_ARRAY+=("core")
              fi
              if [ -n "$react_changes" ]; then
                PACKAGES_ARRAY+=("react")
              fi
              
              # Join array with commas
              IFS=','
              PACKAGES_TO_PUBLISH="${PACKAGES_ARRAY[*]}"
              IFS=' '
            fi
          fi

          echo "packages=$PACKAGES_TO_PUBLISH" >> $GITHUB_OUTPUT
          echo "Packages to publish: ${PACKAGES_TO_PUBLISH:-'none'}"

      - name: Publish Core package
        id: publish-core
        if: contains(steps.packages.outputs.packages, 'core') && steps.packages.outputs.packages != ''
        working-directory: ./packages/core
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "üì¶ Publishing @auth0-web-ui-components/core@$current_version..."

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üîç DRY RUN MODE - Skipping actual publish"
            pnpm publish --dry-run --access public --no-git-checks
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "‚úÖ Dry run completed for @auth0-web-ui-components/core@$current_version"
          else
            pnpm publish --access public --no-git-checks
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "‚úÖ Successfully published @auth0-web-ui-components/core@$current_version"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Publish React package
        id: publish-react
        if: contains(steps.packages.outputs.packages, 'react') && steps.packages.outputs.packages != ''
        working-directory: ./packages/react
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "üì¶ Publishing @auth0-web-ui-components/react@$current_version..."

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üîç DRY RUN MODE - Skipping actual publish"
            pnpm publish --dry-run --access public --no-git-checks
            echo "published=dry-run" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "‚úÖ Dry run completed for @auth0-web-ui-components/react@$current_version"
          else
            pnpm publish --access public --no-git-checks
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$current_version" >> $GITHUB_OUTPUT
            echo "‚úÖ Successfully published @auth0-web-ui-components/react@$current_version"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Import GPG key for signing commits
        if: |
          github.event_name == 'workflow_dispatch' && 
          steps.packages.outputs.packages != ''
        id: import-gpg-pr
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
          git_tag_gpgsign: true

      - name: Create Pull Request with version updates (workflow_dispatch)
        id: cpr
        if: |
          github.event_name == 'workflow_dispatch' && 
          steps.packages.outputs.packages != ''
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6.1.0
        with:
          token: ${{ secrets.PAT }}
          commit-message: |
            chore: update package versions after publish

            Updated packages: ${{ steps.packages.outputs.packages }}
          committer: Harish Sundar <harish.sundar@okta.com>
          author: Harish Sundar <harish.sundar@okta.com>
          signoff: false
          branch: auto-version-bump-${{ github.run_id }}
          delete-branch: true
          title: "chore: update package versions after publish"
          body: |
            ü§ñ **Automated version update after NPM package publish**

            This PR contains version updates that were applied after publishing packages to JFrog Artifactory.

            ## üì¶ Published Packages
            Published packages: `${{ steps.packages.outputs.packages }}`

            ${{ steps.publish-core.outputs.published == 'true' && format('- @auth0-web-ui-components/core@{0}', steps.publish-core.outputs.version) || '' }}
            ${{ steps.publish-react.outputs.published == 'true' && format('- @auth0-web-ui-components/react@{0}', steps.publish-react.outputs.version) || '' }}

            ## üîó Related
            - GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## ‚ö†Ô∏è Action Required
            **This PR will be automatically approved.** The packages have already been published to JFrog Artifactory, and the version updates will be committed back to the repository.

            Commits are signed with GPG key for harish.sundar@okta.com.

      - name: Import GPG key for version bump PR
        if: |
          github.event_name == 'push' && 
          github.ref == 'refs/heads/main' &&
          env.HAS_VERSION_UPDATES == 'true'
        id: import-gpg-version
        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_config_global: true
          git_tag_gpgsign: true

      - name: Create Pull Request with version updates (push)
        id: cpr-version
        if: |
          github.event_name == 'push' && 
          github.ref == 'refs/heads/main' &&
          env.HAS_VERSION_UPDATES == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6.1.0
        with:
          token: ${{ secrets.PAT }}
          commit-message: |
            chore: bump package versions

            ${{ env.UPDATED_PACKAGES_LIST }}
          committer: Harish Sundar <harish.sundar@okta.com>
          author: Harish Sundar <harish.sundar@okta.com>
          signoff: false
          branch: version-bump-${{ github.run_id }}
          delete-branch: true
          title: "chore: bump package versions"
          body: |
            ü§ñ **Automated version bump after merge to main**

            This PR contains version updates that were automatically applied after detecting changes in packages.

            ## üì¶ Updated Packages
            ${{ env.UPDATED_PACKAGES_LIST }}

            ## üîó Related
            - GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - Triggered by commit: ${{ github.sha }}

            ## ‚ö†Ô∏è Action Required
            **This PR will be automatically approved.** Version bumps have been calculated and will be committed back to the repository.

            Commits are signed with GPG key for harish.sundar@okta.com.

      - name: Auto approve (workflow_dispatch)
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@f83b836abaed1b3ab639ae61f9117c52ae405f65 # v2.0.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Auto approve (push)
        if: steps.cpr-version.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@f83b836abaed1b3ab639ae61f9117c52ae405f65 # v2.0.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ steps.cpr-version.outputs.pull-request-number }}

      - name: No packages to publish
        if: |
          steps.packages.outputs.packages == '' && 
          (github.event_name != 'push' || steps.check-skip.outputs.skip != 'true')
        run: |
          echo "## ‚ö†Ô∏è No Packages to Publish" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No packages detected for publishing. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- No changes were detected in any package" >> $GITHUB_STEP_SUMMARY
          echo "- Package versions are already up to date" >> $GITHUB_STEP_SUMMARY
          echo "- Manual package selection excluded all packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí° Tips" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Use manual version inputs to force publish specific packages" >> $GITHUB_STEP_SUMMARY
          echo "- Check if changes were made in the \`packages/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "- Verify the package selection in workflow inputs" >> $GITHUB_STEP_SUMMARY

      - name: Generate workflow summary
        if: steps.packages.outputs.packages != ''
        run: |
          echo "## üì¶ NPM Packages Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.packages.outputs.packages }}" == *"core"* ]]; then
            CORE_VERSION=$(node -p "require('./packages/core/package.json').version" 2>/dev/null || echo "unknown")
            CORE_STATUS="${{ steps.publish-core.outputs.published }}"
            if [ "$CORE_STATUS" = "true" ]; then
              echo "- ‚úÖ @auth0-web-ui-components/core@$CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            elif [ "$CORE_STATUS" = "dry-run" ]; then
              echo "- üîç @auth0-web-ui-components/core@$CORE_VERSION (dry run)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ "${{ steps.packages.outputs.packages }}" == *"react"* ]]; then
            REACT_VERSION=$(node -p "require('./packages/react/package.json').version" 2>/dev/null || echo "unknown")
            REACT_STATUS="${{ steps.publish-react.outputs.published }}"
            if [ "$REACT_STATUS" = "true" ]; then
              echo "- ‚úÖ @auth0-web-ui-components/react@$REACT_VERSION" >> $GITHUB_STEP_SUMMARY
            elif [ "$REACT_STATUS" = "dry-run" ]; then
              echo "- üîç @auth0-web-ui-components/react@$REACT_VERSION (dry run)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** https://a0us.jfrog.io/artifactory/webapp/#/artifacts/browse/tree/General/npm" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Note:** This was a dry run. No packages were actually published." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Slack notification
        if: |
          always() && 
          !cancelled() && 
          github.event.inputs.dry_run != 'true' && 
          github.event.inputs.skip_slack_notification != 'true' &&
          (github.event_name != 'push' || steps.check-skip.outputs.skip != 'true')
        run: |
          echo "üì¨ Preparing Slack notification..."

          # Determine what was actually published
          PUBLISHED_PACKAGES=""
          PUBLISH_ERRORS=""

          # Check core package publishing
          if [ "${{ steps.publish-core.outputs.published }}" = "true" ]; then
            PUBLISHED_PACKAGES="@auth0-web-ui-components/core@${{ steps.publish-core.outputs.version }}"
          elif [ "${{ steps.publish-core.outcome }}" = "failure" ]; then
            PUBLISH_ERRORS="core package failed to publish"
          fi

          # Check react package publishing
          if [ "${{ steps.publish-react.outputs.published }}" = "true" ]; then
            if [ -n "$PUBLISHED_PACKAGES" ]; then
              PUBLISHED_PACKAGES="$PUBLISHED_PACKAGES, @auth0-web-ui-components/react@${{ steps.publish-react.outputs.version }}"
            else
              PUBLISHED_PACKAGES="@auth0-web-ui-components/react@${{ steps.publish-react.outputs.version }}"
            fi
          elif [ "${{ steps.publish-react.outcome }}" = "failure" ]; then
            if [ -n "$PUBLISH_ERRORS" ]; then
              PUBLISH_ERRORS="$PUBLISH_ERRORS, react package failed to publish"
            else
              PUBLISH_ERRORS="react package failed to publish"
            fi
          fi

          # Determine overall status and message
          if [ -z "${{ steps.packages.outputs.packages }}" ]; then
            STATUS="‚ÑπÔ∏è No packages published"
            MESSAGE="No changes detected in packages"
          elif [ -n "$PUBLISHED_PACKAGES" ] && [ -z "$PUBLISH_ERRORS" ]; then
            # All packages published successfully
            if [ "${{ steps.cpr.outcome }}" = "success" ] || [ "${{ steps.cpr-version.outcome }}" = "success" ]; then
              STATUS="‚úÖ Packages published successfully"
              MESSAGE="Published: $PUBLISHED_PACKAGES. PR created for version updates."
            elif [ "${{ steps.cpr.outcome }}" = "failure" ] || [ "${{ steps.cpr-version.outcome }}" = "failure" ]; then
              STATUS="‚ö†Ô∏è Packages published, PR creation failed"  
              MESSAGE="Published: $PUBLISHED_PACKAGES. ‚ùå PR creation failed - manual version update needed."
            else
              STATUS="‚úÖ Packages published successfully"
              MESSAGE="Published: $PUBLISHED_PACKAGES"
            fi
          elif [ -n "$PUBLISHED_PACKAGES" ] && [ -n "$PUBLISH_ERRORS" ]; then
            # Some packages published, some failed
            STATUS="‚ö†Ô∏è Partial publishing failure"
            MESSAGE="‚úÖ Published: $PUBLISHED_PACKAGES. ‚ùå Errors: $PUBLISH_ERRORS"
          elif [ -n "$PUBLISH_ERRORS" ]; then
            # All packages failed to publish
            STATUS="‚ùå Package publishing failed"
            MESSAGE="Errors: $PUBLISH_ERRORS"
          else
            # Fallback for unexpected states
            STATUS="‚ùì Workflow completed with unknown state"
            MESSAGE="Check workflow logs for details"
          fi

          # Get individual package versions for Slack
          CORE_VERSION="Not published"
          REACT_VERSION="Not published"

          if [ "${{ steps.publish-core.outputs.published }}" = "true" ]; then
            CORE_VERSION="${{ steps.publish-core.outputs.version }}"
          fi

          if [ "${{ steps.publish-react.outputs.published }}" = "true" ]; then
            REACT_VERSION="${{ steps.publish-react.outputs.version }}"
          fi

          # Output summary for GitHub logs
          echo "=== WORKFLOW SUMMARY ==="
          echo "Status: $STATUS"
          echo "Message: $MESSAGE"
          echo ""

          # Send notification to Slack (if webhook is configured)
          if [ -n "${{ secrets.SLACK_WORKFLOW_WEBHOOK }}" ]; then
            echo "Sending Slack notification..."
            HTTP_CODE=$(curl -X POST "${{ secrets.SLACK_WORKFLOW_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -w "%{http_code}" \
              -o /tmp/slack_response.txt \
              -d "{
                \"status\": \"$STATUS\",
                \"message\": \"$MESSAGE\",
                \"package_details\": \"${PUBLISHED_PACKAGES:-'No packages published'}\",
                \"core_version\": \"$CORE_VERSION\",
                \"react_version\": \"$REACT_VERSION\",
                \"trigger\": \"${{ github.event_name }}\",
                \"actor\": \"${{ github.actor }}\",
                \"action_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }")
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ Slack notification sent successfully (HTTP $HTTP_CODE)"
            else
              echo "‚ö†Ô∏è Slack notification failed (HTTP $HTTP_CODE)"
              cat /tmp/slack_response.txt
            fi
          else
            echo "‚ÑπÔ∏è Slack webhook not configured, skipping notification"
          fi

      - name: Handle workflow failure
        if: failure()
        run: |
          echo "## ‚ùå Workflow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The workflow encountered an error. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Authentication**: Verify JFrog/Artifactory credentials" >> $GITHUB_STEP_SUMMARY
          echo "- **Version conflict**: Package version may already exist" >> $GITHUB_STEP_SUMMARY
          echo "- **Build failure**: Check if packages build successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Network issues**: JFrog Artifactory may be unreachable" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the error logs in this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix the issue and retry the workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. If needed, manually publish using: \`pnpm publish\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
